<template>
  <b-modal
    v-model="showEditTopicModal"
    body-class="pl-0 pr-0"
    hide-footer
    hide-header
    :no-close-on-backdrop="true"
    :ok-disabled="isSaving"
    @cancel.prevent="cancel"
    @hide.prevent="cancel"
    @shown="$putFocusNextTick('modal-header')"
  >
    <div>
      <ModalHeader>
        <span :class="{'text-secondary': topic.id}">{{ topic.id ? topic.topic : 'Create Topic' }}</span>
      </ModalHeader>
      <div class="modal-body pl-4 pr-5">
        <div v-if="!topic.id" class="topic-label-input-container">
          <label for="topic-label" class="font-size-18 font-weight-bolder mb-1">Label</label>
          <!-- TODO: Fix vue/no-mutating-props offenders below. -->
          <!-- eslint-disable vue/no-mutating-props -->
          <b-form-input
            id="topic-label"
            v-model="topic.topic"
            aria-describedby="input-live-help topic-label-error"
            :maxlength="maxLabelLength"
            :state="!isLabelReserved && isValidLabel"
            required
            size="lg"
          ></b-form-input>
          <b-form-invalid-feedback id="topic-label-error" class="font-size-14 mt-0 pl-2 pt-2">
            <span v-if="!isValidLabel">Label must be {{ minLabelLength }} or more characters.</span>
            <span v-if="isLabelReserved">Sorry, the label '{{ _trim(topic.topic) }}' is assigned to an existing topic.</span>
          </b-form-invalid-feedback>
          <div class="faint-text font-size-14 pl-2 pt-2">
            <span v-if="!isLabelReserved && isValidLabel" id="input-live-help">
              {{ maxLabelLength }} character limit <span v-if="topic.topic.length">({{ maxLabelLength - topic.topic.length }} left)</span>
            </span>
          </div>
        </div>
        <h4 class="font-size-18 font-weight-bolder mb-0" :class="{'pt-2': !topic.id}">Type</h4>
        <span class="font-size-12 text-secondary">You must choose at least one.</span>
        <b-form-checkbox
          id="topic-available-in-notes"
          v-model="topic.availableInNotes"
          class="m-2"
          name="topic-available-in-notes"
        >
          Note Topic
        </b-form-checkbox>
        <b-form-checkbox
          id="topic-available-in-appointments"
          v-model="topic.availableInAppointments"
          class="m-2"
          name="topic-available-in-appointments"
        >
          Appointment Reason
        </b-form-checkbox>
      </div>
      <!-- eslint-enable vue/no-mutating-props -->
      <div class="modal-footer">
        <form @submit.prevent="save">
          <b-btn
            id="topic-save"
            class="btn-primary-color-override"
            :disabled="disableSaveButton"
            variant="primary"
            @click.prevent="save"
          >
            Save
          </b-btn>
          <b-btn
            id="cancel"
            class="pl-3"
            :disabled="isSaving"
            variant="link"
            @click.stop="cancel"
          >
            Cancel
          </b-btn>
        </form>
      </div>
    </div>
  </b-modal>
</template>

<script>
import Context from '@/mixins/Context'
import ModalHeader from '@/components/util/ModalHeader'
import Util from '@/mixins/Util'
import {createTopic, updateTopic} from '@/api/topics'

export default {
  name: 'EditTopicModal',
  components: {ModalHeader},
  mixins: [Context, Util],
  props: {
    afterSave: {
      required: true,
      type: Function
    },
    allTopics: {
      required: true,
      type: Array
    },
    onCancel: {
      required: true,
      type: Function
    },
    topic: {
      required: true,
      type: Object
    }
  },
  data: () => ({
    error: undefined,
    isSaving: false,
    maxLabelLength: 50,
    minLabelLength: 3,
    showEditTopicModal: false
  }),
  computed: {
    disableSaveButton() {
      return !this.isValidLabel || this.isSaving || (!this.topic.availableInAppointments && !this.topic.availableInNotes) || this.isLabelReserved
    },
    isLabelReserved() {
      return !!this._find(this.allTopics, t => {
        const trimmed = this._trim(this.topic.topic)
        return t.id !== this.topic.id && (t.topic.toLowerCase() === trimmed.toLowerCase())
      })
    },
    isValidLabel() {
      return this._trim(this.topic.topic).length >= this.minLabelLength
    }
  },
  created() {
    this.showEditTopicModal = true
  },
  methods: {
    cancel() {
      this.showEditTopicModal = false
      this.onCancel()
    },
    save() {
      this.isSaving = true
      // TODO: do not mutate prop
      this.topic.topic = this._trim(this.topic.topic) // eslint-disable-line vue/no-mutating-props
      if (this.topic.id) {
        updateTopic(
          this.topic.id,
          this.topic.availableInAppointments,
          this.topic.availableInNotes,
          this.topic.topic
        ).then(data => {
          this.afterSave(data)
          this.isSaving = false
          this.showEditTopicModal = false
        })
      } else {
        createTopic(this.topic.availableInAppointments, this.topic.availableInNotes, this.topic.topic).then(data => {
          this.afterSave(data)
          this.isSaving = false
          this.showEditTopicModal = false
        })
      }
    }
  }
}
</script>

<style scoped>
.topic-label-input-container {
  min-height: 110px;
}
</style>
